{% extends "base.html" %}
{% block title %}{{ post.title }}{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h2 class="mb-0">{{ post.title }}</h2>
            {% if current_user.is_authenticated and current_user.id == post.user_id %}
              <a href="{{ url_for('main.edit_post', post_id=post.id) }}" class="btn btn-outline-primary">수정</a>
            {% endif %}
        </div>
        <div class="card-body">
            {% if post.images %}
            <div class="row mb-3">
                {% for filename in post.images %}
                    <div class="col-md-6 mb-3">
                        <img src="{{ url_for('static', filename='uploads/' + filename) }}"
                             class="img-fluid rounded shadow-sm"
                             style="max-height: 400px; object-fit: cover; width: 100%;"
                             alt="악기 이미지">
                    </div>
                {% endfor %}
            </div>
            {% endif %}
<ul class="list-group list-group-flush mb-3">
                <li class="list-group-item"><strong>브랜드:</strong>
                  <span style="color:blue; cursor:pointer;" class="brand-tooltip-trigger" data-brand-id="{{ post.brand_id|default(0) }}">
                    {{ post.brand.name }}
                  </span>
                </li>
                <li class="list-group-item"><strong>모델명:</strong> {{ post.model_name }}</li>
                <li class="list-group-item"><strong>쉐입:</strong>
                  <span style="color:blue; cursor:pointer;" class="shape-tooltip-trigger" data-shape="{{ post.shape }}">
                    {{ post.shape }}
                  </span>
                </li>
                <li class="list-group-item"><strong>상태:</strong>
                    <div class="progress" style="height: 28px; background: #eee;">
                        {% set cond = post.condition|int %}
                        {% if cond >= 80 %}
                            {% set bar_color = 'bg-success' %}
                        {% elif cond >= 60 %}
                            {% set bar_color = 'bg-info' %}
                        {% elif cond >= 40 %}
                            {% set bar_color = 'bg-warning' %}
                        {% else %}
                            {% set bar_color = 'bg-danger' %}
                        {% endif %}
                        <div class="progress-bar {{ bar_color }}" role="progressbar" style="width: {{ cond }}%; font-weight:bold; font-size:1rem;" aria-valuenow="{{ cond }}" aria-valuemin="0" aria-valuemax="100">{{ cond }} / 100</div>
                    </div>
                </li>
                <li class="list-group-item"><strong>가격:</strong>
                    {% if post.price %}{{ "%.0f"|format(post.price) }}만원{% else %}가격 미정{% endif %}
                </li>
                <li class="list-group-item"><strong>작성자:</strong> {{ post.user.username }}</li>
                <li class="list-group-item"><strong>조회수:</strong> {{ post.views }}</li>
            </ul>

            {% if genre_tags %}
            <div class="mb-3">
                <strong>추천 장르:</strong>
                {% for genre in genre_tags %}
                    <span class="badge bg-secondary me-1">{{ genre }}</span>
                {% endfor %}
            </div>
            {% else %}
            <div class="mb-3 text-muted">
                <strong>추천 장르:</strong> 장르 정보 없음
            </div>
            {% endif %}

            {% if current_user.is_authenticated %}
                <button id="like-button" class="btn btn-outline-danger" data-url="{{ url_for('main.toggle_like', post_id=post.id) }}">
                    {% if liked %}
                        ❤️ 좋아요 취소
                    {% else %}
                        🤍 좋아요
                    {% endif %}
                </button>
                <span id="like-count">{{ post.likes|length }}명이 좋아합니다</span>
            {% endif %}

            <hr>
            <h5>설명</h5>
            <p>{{ post.description.replace('\n', '<br>') | safe }}</p>
        </div>
    </div>

    {% if youtube_links %}
        <div class="mb-4">
            <h5>🎵 사운드 샘플</h5>
            {% for link in youtube_links %}
                <div class="mb-3">
                    <iframe class="w-100" height="315" src="{{ link }}" frameborder="0" allowfullscreen></iframe>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="mb-4 text-muted">유튜브 샘플 영상을 찾을 수 없습니다.</div>
    {% endif %}

    <a href="{{ url_for('main.index') }}" class="btn btn-secondary mb-4">← 목록으로 돌아가기</a>

    <!-- 댓글 영역 -->
    <div class="card mb-4">
      <div class="card-header">
        💬 댓글
      </div>
      <div class="card-body">
        {% if current_user.is_authenticated %}
        <form id="comment-form" data-url="{{ url_for('main.add_comment', post_id=post.id) }}">
          <div class="mb-3">
            <textarea id="comment-content" class="form-control" rows="3" placeholder="댓글을 입력하세요!" required></textarea>
          </div>
          <button type="submit" class="btn btn-primary">댓글 작성</button>
        </form>
        {% else %}
          <p><a href="{{ url_for('auth.login') }}">로그인</a> 후 댓글을 작성하실 수 있습니다.</p>
        {% endif %}
      </div>
      <ul id="comment-list" class="list-group list-group-flush">
        {% for comment in comments %}
          <li class="list-group-item" id="comment-{{ comment.id }}">
            <strong>{{ comment.user.username }}</strong>
            <small class="text-muted">({{ comment.created_at.strftime('%Y-%m-%d %H:%M') }})</small>
            {% if current_user.is_authenticated and current_user.id == comment.user_id %}
              <button class="btn btn-sm btn-outline-danger float-end delete-comment" data-comment-id="{{ comment.id }}">삭제</button>
            {% endif %}
            <br>{{ comment.content|safe }}
            <div class="mt-2">
              <a href="javascript:void(0);" onclick="toggleReplyForm('{{ comment.id }}')">&#8618; 답글</a>
              <form id="reply-form-{{ comment.id }}" class="reply-form mt-2" style="display:none;">
                <div class="input-group">
                  <input type="text" class="form-control reply-input" placeholder="답글을 입력하세요" data-parent-id="{{ comment.id }}">
                  <button type="button" class="btn btn-sm btn-outline-primary reply-submit">작성</button>
                </div>
              </form>
            </div>
            <div id="reply-list-{{ comment.id }}">
              {% for reply in comment.replies_list %}
                <div class="mt-3 ms-4 border-start ps-3" id="comment-{{ reply.id }}">
                  <strong>{{ reply.user.username }}</strong>
                  <small class="text-muted">({{ reply.created_at.strftime('%Y-%m-%d %H:%M') }})</small>
                  {% if current_user.is_authenticated and current_user.id == reply.user_id %}
                    <button class="btn btn-sm btn-outline-danger float-end delete-comment" data-comment-id="{{ reply.id }}">삭제</button>
                  {% endif %}
                  <br>{{ reply.content|safe }}
                </div>
              {% endfor %}
            </div>
          </li>
        {% endfor %}
      </ul>
    </div>

    <!-- 툴팁 영역 (한 번만) -->
    <div id="infoTooltip" class="brand-tooltip"></div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='view_post.js') }}"></script>
<script>
// 툴팁/답글 토글 window에 등록 (외부 JS에서 접근)
window.showTooltip = showTooltip;
window.hideTooltip = hideTooltip;
window.toggleReplyForm = toggleReplyForm;
</script>
{% endblock %}
