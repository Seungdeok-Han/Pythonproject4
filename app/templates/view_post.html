{% extends "base.html" %}
{% block title %}{{ post.title }}{% endblock %}

{% block content %}
<style>
/* Only show underline on hover/focus for tooltip triggers */
.brand-tooltip-trigger, .shape-tooltip-trigger, #famous-users-tooltip-trigger {
  text-decoration: none;
  transition: text-decoration 0.2s;
}
.brand-tooltip-trigger:hover, .brand-tooltip-trigger:focus,
.shape-tooltip-trigger:hover, .shape-tooltip-trigger:focus,
#famous-users-tooltip-trigger:hover, #famous-users-tooltip-trigger:focus {
  text-decoration: underline dotted;
}
</style>
<div class="container my-4">
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h2 class="mb-0">{{ post.title }}</h2>
            {% if current_user.is_authenticated and current_user.id == post.user_id %}
              <a href="{{ url_for('main.edit_post', post_id=post.id) }}" class="btn btn-outline-primary">ìˆ˜ì •</a>
            {% endif %}
        </div>
        <div class="card-body">
            {% if post.images %}
            <div class="row mb-3">
                {% for filename in post.images %}
                    <div class="col-md-6 mb-3">
                        <img src="{{ url_for('static', filename='uploads/' + filename) }}"
                             class="img-fluid rounded shadow-sm"
                             style="max-height: 400px; object-fit: cover; width: 100%;"
                             alt="ì•…ê¸° ì´ë¯¸ì§€">
                    </div>
                {% endfor %}
            </div>
            {% endif %}
<ul class="list-group list-group-flush mb-3">
                <li class="list-group-item"><strong>ë¸Œëœë“œ:</strong>
  <span class="brand-tooltip-trigger" style="color:blue; cursor:pointer;"
        data-brand-id="{{ post.brand.id }}"
        onmouseover="window.showTooltip(event, 'brand', '{{ post.brand.id }}')"
        onmouseout="window.hideTooltip()"
        id="brand-tooltip">
    {{ post.brand.name }}
  </span>
</li>
                <li class="list-group-item"><strong>ëª¨ë¸ëª…:</strong> {{ post.model_name }}
  {% if famous_users_for_model %}
  <span class="ms-2 text-primary" id="famous-users-tooltip-trigger" style="cursor:pointer;" data-bs-toggle="tooltip" data-bs-placement="right" title="{{ famous_users_for_model }}">
    ì´ ê¸°íƒ€ë¥¼ ì‚¬ìš©í•œ ì‚¬ëŒì€?
  </span>
  {% else %}
  <span class="ms-2 text-muted" style="font-size:0.95em;">(ìœ ëª… í”Œë ˆì´ì–´ ì •ë³´ ì—†ìŒ)</span>
  {% endif %}
</li>
                <li class="list-group-item"><strong>ì‰ì…:</strong>
                  <span class="shape-tooltip-trigger" style="color:blue; cursor:pointer;"
                        data-shape="{{ post.shape|e }}"
                        onmouseover="window.showShapeTooltip(event, '{{ post.shape|e }}')"
                        onmouseout="window.hideTooltip()"
                        id="shape-tooltip">
                    {{ post.shape }}
                  </span>
                </li>
                <li class="list-group-item"><strong>ìƒíƒœ:</strong>
                    <div class="progress" style="height: 28px; background: #eee;">
                        {% set cond = post.condition|int %}
                        {% if cond >= 80 %}
                            {% set bar_color = 'bg-success' %}
                        {% elif cond >= 60 %}
                            {% set bar_color = 'bg-info' %}
                        {% elif cond >= 40 %}
                            {% set bar_color = 'bg-warning' %}
                        {% else %}
                            {% set bar_color = 'bg-danger' %}
                        {% endif %}
                        <div class="progress-bar {{ bar_color }}" role="progressbar" style="width: {{ cond }}%; font-weight:bold; font-size:1rem;" aria-valuenow="{{ cond }}" aria-valuemin="0" aria-valuemax="100">{{ cond }} / 100</div>
                    </div>
                </li>
                <li class="list-group-item"><strong>ê°€ê²©:</strong>
                    {% if post.price %}{{ "%.0f"|format(post.price) }}ë§Œì›{% else %}ê°€ê²© ë¯¸ì •{% endif %}
                </li>
                <li class="list-group-item"><strong>ì‘ì„±ì:</strong> {{ post.user.username }}</li>
                <li class="list-group-item"><strong>ì¡°íšŒìˆ˜:</strong> {{ post.views }}</li>
            </ul>

            {% if genre_tags %}
            <div class="mb-3">
                <strong>ì¶”ì²œ ì¥ë¥´:</strong>
                {% for genre in genre_tags %}
                    <span class="badge bg-secondary me-1">{{ genre }}</span>
                {% endfor %}
            </div>
            {% else %}
            <div class="mb-3 text-muted">
                <strong>ì¶”ì²œ ì¥ë¥´:</strong> ì¥ë¥´ ì •ë³´ ì—†ìŒ
            </div>
            {% endif %}

            {% if current_user.is_authenticated %}
                <button id="like-button" class="btn btn-outline-danger" data-url="{{ url_for('main.toggle_like', post_id=post.id) }}">
                    {% if liked %}
                        â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ
                    {% else %}
                        ğŸ¤ ì¢‹ì•„ìš”
                    {% endif %}
                </button>
                <span id="like-count">{{ post.likes|length }}ëª…ì´ ì¢‹ì•„í•©ë‹ˆë‹¤</span>
            {% endif %}

            <div class="d-flex justify-content-end align-items-center mb-2">
            {% if post.status == 'available' %}
                <span class="badge bg-success fs-6 px-3 py-2" style="font-size:1.1rem;">ê±°ë˜ ê°€ëŠ¥</span>
            {% elif post.status == 'reserved' %}
                <span class="badge bg-warning text-dark fs-6 px-3 py-2" style="font-size:1.1rem;">ê±°ë˜ì¤‘</span>
            {% elif post.status == 'sold' %}
                <span class="badge bg-secondary fs-6 px-3 py-2" style="font-size:1.1rem;">ê±°ë˜ ì™„ë£Œ</span>
            {% endif %}
        </div>

            <hr>
            <h5>ì„¤ëª…</h5>
            <p>{{ post.description.replace('\n', '<br>') | safe }}</p>
        </div>
    </div>

    {% if youtube_links %}
        <div class="mb-4">
            <h5>ğŸµ ì‚¬ìš´ë“œ ìƒ˜í”Œ</h5>
            {% for link in youtube_links %}
                <div class="mb-3">
                    <iframe class="w-100" height="315" src="{{ link }}" frameborder="0" allowfullscreen></iframe>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="mb-4 text-muted">ìœ íŠœë¸Œ ìƒ˜í”Œ ì˜ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
    {% endif %}

    <a href="{{ url_for('main.index') }}" class="btn btn-secondary mb-4">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>

    <div class="row">
      <div class="col-md-8">
        <!-- ê¸°ì¡´ ìƒì„¸ ë‚´ìš© ... -->
      </div>
      <div class="col-md-4">
        <!-- ìœ ì‚¬ ì•…ê¸° ì¶”ì²œ ì˜ì—­ -->
        <div class="card mb-4 shadow-sm">
          <div class="card-header bg-light fw-bold">ì´ ì•…ê¸°ì™€ ë¹„ìŠ·í•œ ë§¤ë¬¼</div>
          <div class="card-body">
            {% if similar_posts and similar_posts|length > 0 %}
              {% for sim in similar_posts %}
                <div class="mb-3 border-bottom pb-2">
                  <a href="{{ url_for('main.view_post', post_id=sim.id) }}" class="fw-bold" style="font-size:1.1em;">{{ sim.title }}</a><br>
                  <span class="text-muted">{{ sim.brand.name if sim.brand else '' }} / {{ sim.model_name }}</span><br>
                  <span class="badge bg-secondary me-1">{{ sim.shape }}</span>
                  {% if sim.price %}<span class="badge bg-info text-dark">{{ '%.0f'|format(sim.price) }}ë§Œì›</span>{% endif %}
                  {% if sim.status == 'available' %}
                    <span class="badge bg-success">ê±°ë˜ ê°€ëŠ¥</span>
                  {% elif sim.status == 'reserved' %}
                    <span class="badge bg-warning text-dark">ê±°ë˜ì¤‘</span>
                  {% elif sim.status == 'sold' %}
                    <span class="badge bg-secondary">ê±°ë˜ ì™„ë£Œ</span>
                  {% endif %}
                </div>
              {% endfor %}
            {% else %}
              <div class="text-muted">ë¹„ìŠ·í•œ ë§¤ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- ëŒ“ê¸€ ì˜ì—­ -->
    <div class="card mb-4">
      <div class="card-header">
        ğŸ’¬ ëŒ“ê¸€
      </div>
      <div class="card-body">
        {% if current_user.is_authenticated %}
        <form id="comment-form" data-url="{{ url_for('main.add_comment', post_id=post.id) }}">
          <div class="mb-3">
            <textarea id="comment-content" class="form-control" rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”!" required></textarea>
          </div>
          <button type="submit" class="btn btn-primary">ëŒ“ê¸€ ì‘ì„±</button>
        </form>
        {% else %}
          <p><a href="{{ url_for('auth.login') }}">ë¡œê·¸ì¸</a> í›„ ëŒ“ê¸€ì„ ì‘ì„±í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        {% endif %}
      </div>
      <ul id="comment-list" class="list-group list-group-flush">
        {% for comment in comments %}
          <li class="list-group-item" id="comment-{{ comment.id }}">
            <strong>{{ comment.user.username }}</strong>
            <small class="text-muted">({{ comment.created_at.strftime('%Y-%m-%d %H:%M') }})</small>
            {% if current_user.is_authenticated and current_user.id == comment.user_id %}
              <button class="btn btn-sm btn-outline-danger float-end delete-comment" data-comment-id="{{ comment.id }}">ì‚­ì œ</button>
            {% endif %}
            <br>{{ comment.content|safe }}
            <div class="mt-2">
              <a href="javascript:void(0);" onclick="toggleReplyForm('{{ comment.id }}')">&#8618; ë‹µê¸€</a>
              <form id="reply-form-{{ comment.id }}" class="reply-form mt-2" style="display:none;">
                <div class="input-group">
                  <input type="text" class="form-control reply-input" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" data-parent-id="{{ comment.id }}">
                  <button type="button" class="btn btn-sm btn-outline-primary reply-submit">ì‘ì„±</button>
                </div>
              </form>
            </div>
            <div id="reply-list-{{ comment.id }}">
              {% for reply in comment.replies_list %}
                <div class="mt-3 ms-4 border-start ps-3" id="comment-{{ reply.id }}">
                  <strong>{{ reply.user.username }}</strong>
                  <small class="text-muted">({{ reply.created_at.strftime('%Y-%m-%d %H:%M') }})</small>
                  {% if current_user.is_authenticated and current_user.id == reply.user_id %}
                    <button class="btn btn-sm btn-outline-danger float-end delete-comment" data-comment-id="{{ reply.id }}">ì‚­ì œ</button>
                  {% endif %}
                  <br>{{ reply.content|safe }}
                </div>
              {% endfor %}
            </div>
          </li>
        {% endfor %}
      </ul>
    </div>

    <!-- íˆ´íŒ ì˜ì—­ (í•œ ë²ˆë§Œ) -->
    <div id="infoTooltip" class="brand-tooltip"></div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='view_post.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.forEach(function (tooltipTriggerEl) {
    new bootstrap.Tooltip(tooltipTriggerEl);
  });
});
</script>
{% endblock %}
